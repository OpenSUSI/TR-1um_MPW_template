# Design Rule Check (DRC) Workflow
# This workflow automates the DRC process using KLayout to verify that the GDS design
# meets all the manufacturing rules defined in the technology ruleset
name: check

# Workflow trigger conditions
on:
  # Automatically run DRC on every push to the repository
  push:
  # Allow manual workflow dispatch from GitHub Actions UI
  workflow_dispatch:

jobs:
  # DRC job definition - executes on Ubuntu Latest Runner
  precheck:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Clone the repository to get the project files
      - uses: actions/checkout@v4

      # Step 2: Install required dependencies and tools
      # - KLayout: Open-source layout viewer and editor with DRC capabilities
      # - Python3: Required to parse the info.yaml configuration file
      # - PyYAML: Python library for reading YAML configuration files
      - name: Install KLayout + deps
        run: |
          python3 -m pip install --user pyyaml
          python3 -m pip install --user click
          python3 -m pip install --user klayout

      # Step 3: Parse configuration from info.yaml
      # This step reads the DRC configuration parameters from the project info.yaml file:
      # - gds.file: Path to the GDS file to be checked
      # - gds.top_cell: Top-level cell name in the GDS file
      # - drc.repo: Repository containing the DRC rule definitions
      # - drc.ref: Git reference (branch/tag) of the ruleset repo
      # - drc.entry: Path to the DRC rules entry point in the ruleset
      # - drc.report: Path where the DRC report will be generated
      # The parsed values are stored as GitHub Actions outputs for use in subsequent steps
      - name: Read info.yaml
        id: cfg
        run: |
          python3 - << 'PY'
          import yaml, os, pathlib
          cfg     = yaml.safe_load(pathlib.Path("info.yaml").read_text())
          gds     = cfg["gds"]["file"]
          cell    = cfg["gds"]["top_cell"]
          repo    = cfg["drc"]["repo"]
          ref     = cfg["drc"]["ref"]
          entry   = cfg["drc"]["entry"]
          report  = cfg["drc"]["report"]
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"gds={gds}\n")
            f.write(f"cell={cell}\n")
            f.write(f"repo={repo}\n")
            f.write(f"ref={ref}\n")
            f.write(f"entry={entry}\n")
            f.write(f"report={report}\n")
          PY

      # Step 4: Clone the DRC ruleset repository
      # This step downloads the technology-specific DRC rules from the remote repository.
      # Uses sparse checkout to only clone the specific DRC entry point path (typically libs.tech),
      # reducing download size and improving performance.
      # The git clone uses:
      # - --filter=blob:none: Enables partial clone (blobless clone)
      # - --sparse: Starts with empty working directory (only clones metadata)
      # - --branch: Checks out the specific branch/tag version of the ruleset
      # Then sparse-checkout adds only the required DRC rules directory
      - name: Checkout libs.tech from ruleset repo 
        run: |
          git clone --filter=blob:none --sparse --branch "${{ steps.cfg.outputs.ref }}"\
             "${{ steps.cfg.outputs.repo }}" TR-1um
          ( cd TR-1um ; git sparse-checkout add ${{ steps.cfg.outputs.entry }} )

      - name: Run python script
        run: |
          python3 script/pre_check.py -top "${{ steps.cfg.outputs.cell }}" \
            -input "${{ steps.cfg.outputs.gds }}"

  drc:
    runs-on: ubuntu-latest
    needs: precheck
    steps:
      - uses: actions/checkout@v4
      # Step 2: Install required dependencies and tools
      # - KLayout: Open-source layout viewer and editor with DRC capabilities
      # - Python3: Required to parse the info.yaml configuration file
      # - PyYAML: Python library for reading YAML configuration files
      - name: Install KLayout + deps
        run: |
          sudo apt-get update
          sudo apt-get install -y klayout git
          python3 -m pip install --user pyyaml
          klayout -v

      - name: Checkout libs.tech from ruleset repo 
        run: |
          git clone --filter=blob:none --sparse --branch "${{ steps.cfg.outputs.ref }}"\
             "${{ steps.cfg.outputs.repo }}" TR-1um
          ( cd TR-1um ; git sparse-checkout add ${{ steps.cfg.outputs.entry }} )
    #
      - name: Run DRC (headless)
        run: |
          klayout -b -r "TR-1um/libs.tech/klayout/drc/run.drc" \
            -rd input="${{ steps.cfg.outputs.gds }}" \
            -rd top_cell="${{ steps.cfg.outputs.cell }}" \
            -rd report="${{ steps.cfg.outputs.report }}"

      # Step 6: Upload DRC results as GitHub Actions artifact
      # This step packages the DRC reports from the log/ directory and makes them available
      # for download from the GitHub Actions run summary page.
      # Artifact name: "drc-report" - used to identify and download the results
      # Path: log/ - directory containing DRC report files generated by KLayout
      - uses: actions/upload-artifact@v4
        with:
          name: drc-report
          path: src/${{ steps.cfg.outputs.report }}